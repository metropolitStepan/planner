# Планировщик спортивного мероприятия

Веб-интерфейс и API-адаптер для формирования расписания соревновательного дня на основе исходных данных.

## Требования

- Python 3.10+
- Node.js 18+

## Установка и запуск

### 1. Установка зависимостей Python

```bash
python3 -m venv .venv
source .venv/bin/activate  # Windows: .\.venv\Scripts\Activate.ps1
pip install fastapi uvicorn pydantic python-multipart pandas openpyxl
```

### 2. Запуск API-сервера

```bash
uvicorn api_adapter:app --reload --port 8000
```

Проверка: `curl http://127.0.0.1:8000/health`

### 3. Запуск фронтенда

```bash
cd planner/frontend
npm install
npm run dev
```

Откройте `http://localhost:5173` в браузере.

## Использование

1. Запустите API-сервер и фронтенд (см. выше)
2. На вкладке «Загрузка данных» загрузите файл `.xlsx` или `.csv`
3. На вкладке «Параметры» укажите:
   - дату соревновательного дня
   - временное окно (начало и окончание)
   - длительность слота
   - список площадок и групп
4. Нажмите «Сформировать расписание»
5. На вкладке «Расписание» просмотрите результат

## Формат входных данных

### Excel-файл

Файл должен быть в формате `.xlsx` (Microsoft Excel) или `.csv` и содержать следующие листы с указанными колонками:

#### Лист "Упражнения"

Содержит информацию о типах упражнений и их длительности.

| Колонка | Тип | Описание | Пример |
|---------|-----|----------|--------|
| `Название` | Строка | Название упражнения (уникальное) | "Индивидуальная", "Командная" |
| `Длительность` | Число | Длительность выполнения упражнения одним участником в минутах | 15, 30, 45 |

**Пример:**
```
Название        | Длительность
----------------|-------------
Индивидуальная  | 15
Командная       | 30
```

#### Лист "Этапы"

Содержит информацию о максимальном количестве участников на каждом этапе соревнования.

| Колонка | Тип | Описание | Пример |
|---------|-----|----------|--------|
| `МаксимумУчастников` | Число | Максимальное количество участников на этапе | 5, 10, 20 |

**Пример:**
```
МаксимумУчастников
------------------
5
10
20
```

#### Лист "Корты"

Содержит информацию о площадках и их расписании работы. Одна площадка может иметь несколько строк, если в её работе есть перерывы.

| Колонка | Тип | Описание | Пример |
|---------|-----|----------|--------|
| `Корт` | Строка | Название/идентификатор площадки | "Зал 1", "Корт А" |
| `Открытие` | Время | Время начала работы площадки | "09:00", "10:30" |
| `Закрытие` | Время | Время окончания работы площадки | "18:00", "20:00" |

**Пример:**
```
Корт   | Открытие | Закрытие
-------|----------|----------
Зал 1  | 09:00    | 13:00
Зал 1  | 14:00    | 18:00
Зал 2  | 09:00    | 18:00
```

#### Лист "Группы"

Содержит информацию о группах участников, которые нужно разместить в расписании.

| Колонка | Тип | Обязательное | Описание | Пример |
|---------|-----|--------------|----------|--------|
| `ИмяГруппы` | Строка | Да | Название/идентификатор группы | "Группа А", "Команда 1" |
| `КоличествоУчастников` | Число | Да | Количество участников в группе | 10, 15, 20 |
| `Упражнение` | Строка | Да | Название упражнения (должно совпадать с `Название` из листа "Упражнения") | "Индивидуальная" |
| `МинимальноеВремяНачала` | Время/Число | Нет | Наиболее раннее время для размещения группы (в минутах от начала дня или время) | 540 (09:00), "09:00" |
| `МаксимальноеВремяОкончания` | Время/Число | Нет | Время, к которому группа должна завершить все этапы (в минутах от начала дня или время) | 1080 (18:00), "18:00" |

**Важно:** Если `МинимальноеВремяНачала` или `МаксимальноеВремяОкончания` не указаны, система автоматически использует минимальное время открытия и максимальное время закрытия всех кортов.

**Пример:**
```
ИмяГруппы | КоличествоУчастников | Упражнение      | МинимальноеВремяНачала | МаксимальноеВремяОкончания
----------|---------------------|-----------------|------------------------|---------------------------
Группа А  | 10                  | Индивидуальная  | 540                    | 1080
Группа Б  | 15                  | Командная       |                        | 1200
Группа В  | 8                   | Индивидуальная  | 600                    |
```

### Параметры в интерфейсе

После загрузки Excel-файла необходимо указать следующие параметры через веб-интерфейс:

- **Дата соревновательного дня** — дата проведения мероприятия (формат: YYYY-MM-DD)
- **Временное окно** — общее время проведения соревнований:
  - Время начала (формат: HH:MM)
  - Время окончания (формат: HH:MM)
- **Длительность слота** — минимальная единица времени для планирования (в минутах, от 5 до 180)
- **Список площадок** — минимум одна площадка (можно добавить через интерфейс)
- **Список групп** — минимум одна группа (можно добавить через интерфейс)

**Примечание:** Площадки и группы, указанные в интерфейсе, должны соответствовать данным из Excel-файла. Система использует Excel-файл для получения детальной информации о группах и площадках, а параметры интерфейса задают общие настройки планирования.

## API

### Эндпоинты

- `POST /upload` — загрузка файла
- `POST /schedule/plan` — формирование расписания
- `GET /schedule/{plan_id}` — получение расписания по ID
- `GET /health` — проверка работоспособности

### Формат запроса на формирование расписания

```json
{
  "window": {
    "date": "2024-01-01",
    "startTime": "09:00",
    "endTime": "18:00"
  },
  "courts": [
    {"id": "c1", "name": "Зал 1"}
  ],
  "groups": [
    {"id": "g1", "name": "Группа 1", "size": 10, "tags": []}
  ],
  "slotMinutes": 15,
  "parallelLimit": 2,
  "constraints": [],
  "options": {}
}
```

## Интеграция с planner.py

Адаптер автоматически пытается:
1. Импортировать функцию `generate_schedule` из `planner.py` и вызвать её
2. Если импорт не удался, запустить `planner.py` как процесс и передать данные через stdin

Путь к загруженному файлу передаётся в `params.options.lastUploadPath`.

## Сборка фронтенда

```bash
cd planner/frontend
npm run build
```

Результат в `planner/frontend/dist`.
